#!/usr/bin/env python
# encoding: utf-8
#
# @Author: Michael R. Blanton
# @Date: Sept 26, 2018
# @Filename: rs_assign_open
# @License: BSD 3-Clause
# @Copyright: Michael R. Blanton


from __future__ import division
from __future__ import print_function
from __future__ import absolute_import
from __future__ import unicode_literals

import os
os.environ['OPENBLAS_NUM_THREADS'] = '1'

import argparse
import sys
import multiprocessing
import datetime
import numpy as np
import roboscheduler.cadence as cadence
import robostrategy.field as field
import robostrategy.params as params
import sdss_access.path
import pdb
import fitsio
import time
from astropy.coordinates.angle_utilities import angular_separation

sdss_path = sdss_access.path.Path(release='sdss5', preserve_envvars=True)


def assign_field(indx):
    print(time.ctime(time.time()))

    fieldid = fields_array['fieldid'][indx]
    if((fieldid % 1) == 0):
        print(fieldid, flush=True)

    print("Reading target file", flush=True)
    field_assigned_file_orig = sdss_path.full('rsFieldAssignments',
                                              plan=plan,
                                              observatory=observatory,
                                              fieldid=fieldid)
    field_open_file = field_assigned_file_orig.replace('rsFieldAssignments',
                                                       'rsFieldTargetsOpen')
    if(fromreassign):
        field_assigned_file = field_assigned_file_orig.replace('targets/rsFieldAssignments',
                                                               'targets/rsFieldReassignments')
    else:
        field_assigned_file = field_assigned_file_orig

    print("fieldid={f}: Read in field".format(f=fieldid), flush=True)
    f = field.Field(filename=field_assigned_file, verbose=True,
                    fieldid=fieldid)

    print("fieldid={f}: Add open targets".format(f=fieldid), flush=True)
    opentargets = fitsio.read(field_open_file, ext='TARGET')
    f.targets_fromarray(opentargets)

    print("fieldid={f}: Assign open targets".format(f=fieldid), flush=True)
    f.assign_science(stage='open')

    print("fieldid={f}: Write assignments".format(f=fieldid), flush=True)
    field_out_file = field_assigned_file_orig.replace('rsFieldAssignments',
                                                      'rsFieldAssignmentsOpen')
    f.tofits(field_out_file)

    print("Done fieldid={f}".format(f=fieldid), flush=True)


if __name__ == '__main__':

    parser = argparse.ArgumentParser(
        prog=os.path.basename(sys.argv[0]),
        description='Final assignment based on allocation')

    parser.add_argument('-p', '--plan', dest='plan',
                        type=str, help='name of plan', required=True)
    parser.add_argument('-o', '--observatory', dest='observatory',
                        type=str, help='apo or lco',
                        choices=['apo', 'lco'], required=True)
    parser.add_argument('-s', '--start', dest='start',
                        type=np.int32, help='field to start', required=False,
                        default=0)
    parser.add_argument('-e', '--end', dest='end',
                        type=np.int32, help='field to end', required=False,
                        default=-1)
    parser.add_argument('-k', '--no-clobber', dest='noclobber',
                        help='do not clobber', required=False,
                        default=False, action='store_true')
    parser.add_argument('-f', '--from-reassign', dest='fromreassign',
                        help='base on reassign', required=False,
                        default=False, action='store_true')

    args = parser.parse_args()
    plan = args.plan
    observatory = args.observatory
    start = args.start
    end = args.end
    noclobber = args.noclobber
    fromreassign = args.fromreassign

    rsParams = params.RobostrategyParams(plan=plan)
    if('Rotate' in rsParams.cfg['Fields']):
        rotate = True
        paname = rsParams.cfg['Fields']['Rotate']
    else:
        rotate = False
        paname = ''

    fields_file = sdss_path.full('rsFields', plan=plan,
                                 observatory=observatory)
    if(rotate):
        fields_file = fields_file.replace('rsFields', 'rsFieldsRotated')
    fields_array = fitsio.read(fields_file)

    cadencelist = cadence.CadenceList(skybrightness_only=True)
    cadences_file = sdss_path.full('rsCadences', plan=plan,
                                   observatory=observatory)
    cadencelist.fromfits(filename=cadences_file, unpickle=True)

    if(end < 0):
        end = fields_array['fieldid'].max()

    ikeep = np.where((fields_array['fieldid'] >= start) &
                     (fields_array['fieldid'] <= end))[0]

    np.random.shuffle(ikeep)
    with multiprocessing.Pool() as pool:
        pool.map(assign_field, ikeep)
    print('DONE: rs_assign_open')
