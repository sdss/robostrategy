#!/usr/bin/env python
# encoding: utf-8
#
# @Author: Michael R. Blanton
# @Date: Aug 3, 2018
# @Filename: rs_targets_extract
# @License: BSD 3-Clause
# @Copyright: Michael R. Blanton


from __future__ import division
from __future__ import print_function
from __future__ import absolute_import
from __future__ import unicode_literals

import configparser
import argparse
import os
import sys
import numpy as np
import fitsio
import roboscheduler.cadence as cadence
import sdssdb.peewee.sdss5db.targetdb as targetdb
import sdss_access.path

sdss_path = sdss_access.path.Path()

#function to extract targets from targeting database
def get_targets(cfg=None):

    #define the format target info will be stored in.
    target0 = [('targetid', np.int32),
               ('pk', np.int64),    #<--- primary key in database (how different from target ID?)
               ('ra', np.float64),
               ('dec', np.float64),
               ('program', np.dtype('a30')),
               ('cadence', cadence.fits_type),
               ('category', np.dtype('a30'))]

    #set up a structure to hold targets.
    targets = np.zeros(0, dtype=target0)

    #loop through each of the program types in the config/param file.
    for program in cfg['Programs']:
        print(program)

        #find the number of targets of this program type.
        nt = (targetdb.Target.select(targetdb.Target.pk)
              .join(targetdb.Program)
              .where(targetdb.Program.label == program)).count()

        #if there are any targets from this program, import them
        if(nt > 0):

            #set up a temporary target structure
            tmp_targets = np.zeros(nt, dtype=target0)

            #pull out the info for each target that we want to save per our format above
            ts = (targetdb.Target.select(targetdb.Target.ra,
                                         targetdb.Target.dec,
                                         targetdb.Target.pk,
                                         targetdb.Program.label.alias('program'),
                                         targetdb.TargetCadence.name.alias('cadence'))
                  .join(targetdb.Program).switch(targetdb.Target)
                  .join(targetdb.TargetCadence)
                  .where(targetdb.Program.label == program)).dicts()

            #run through each of the targets we pulled in the step above
            #and save it to our temporary structure
            for indx, t in zip(np.arange(nt), ts):
                tmp_targets['ra'][indx] = t['ra']
                tmp_targets['dec'][indx] = t['dec']
                tmp_targets['pk'][indx] = t['pk']
                tmp_targets['program'][indx] = t['program']
                tmp_targets['cadence'][indx] = t['cadence']
                tmp_targets['category'][indx] = 'SCIENCE'

            #add the temporary targets to the real target list.
            targets = np.append(targets, tmp_targets)

    # Now add skies and standards; define the number to add 
    nrandom = 4000000

    #loop through both flux and sky standards
    for skystandard in ['STANDARD', 'SKY']:
        
        #select standards for each instrument
        for instrument in ['APOGEE', 'BOSS']:

            #save the type
            category = "{ss}_{inst}".format(ss=skystandard, inst=instrument)
            print(category)

            #distribute them randomly (but evenly) across the sky
            costhrandom = np.random.random(size=nrandom) * 2. - 1.
            thrandom = np.arccos(costhrandom) * 180. / np.pi
            decrandom = 90. - thrandom
            rarandom = np.random.random(size=nrandom) * 360.

            #save them as new targets
            new_targets = np.zeros(nrandom, dtype=target0)
            new_targets['ra'] = rarandom
            new_targets['dec'] = decrandom
            new_targets['pk'] = -1
            new_targets['program'] = 'CALIBRATION'
            new_targets['cadence'] = 'none'
            new_targets['category'] = category
            targets = np.append(targets, new_targets)

    targets['targetid'] = np.arange(len(targets), dtype=np.int32)

    return(targets)


if __name__ == '__main__':

    parser = argparse.ArgumentParser(
        prog=os.path.basename(sys.argv[0]),
        description='Export targets as a FITS file')

    parser.add_argument('-p', '--plan', dest='plan',
                        type=str, help='name of plan', required=True)
    parser.add_argument('-o', '--observatory', dest='observatory',
                        type=str, help='apo or lco',
                        choices=['apo', 'lco'], required=True)

    args = parser.parse_args()
    plan = args.plan
    observatory = args.observatory

    cfgfile = os.path.join(os.getenv('ROBOSTRATEGY_DIR'), 'etc',
                           'robostrategy-{plan}.cfg'.format(plan=plan))
    cfg = configparser.ConfigParser(allow_no_value=True)
    cfg.optionxform = str
    cfg.read(cfgfile)

    targets = get_targets(cfg=cfg)

    targets_file = sdss_path.full('rsTargets', plan=plan,
                                  observatory=observatory)
    fitsio.write(targets_file, targets, clobber=True)
