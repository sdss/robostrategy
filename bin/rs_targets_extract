#!/usr/bin/env python
# encoding: utf-8
#
# @Author: Michael R. Blanton
# @Date: Aug 3, 2018
# @Filename: rs_targets_extract
# @License: BSD 3-Clause
# @Copyright: Michael R. Blanton


from __future__ import division
from __future__ import print_function
from __future__ import absolute_import
from __future__ import unicode_literals

import configparser
import argparse
import os
import sys
import numpy as np
import fitsio
import robostrategy
import roboscheduler.cadence
import robostrategy.params as params
import robostrategy.targets
import sdss_access.path

sdss_path = sdss_access.path.Path(release='sdss5', preserve_envvars=True)


if __name__ == '__main__':

    parser = argparse.ArgumentParser(
        prog=os.path.basename(sys.argv[0]),
        description='Export targets as a FITS file')

    parser.add_argument('-p', '--plan', dest='plan',
                        type=str, help='name of plan', required=True)
    parser.add_argument('-o', '--observatory', dest='observatory',
                        type=str, help='apo or lco',
                        choices=['apo', 'lco'], required=True)
    parser.add_argument('-A', '--all-stages', dest='all_stages',
                        help='set to read all target stages',
                        default=False, required=False,
                        action='store_true')
    parser.add_argument('-O', '--open', dest='opentargets',
                        help='set to read open target',
                        default=False, required=False,
                        action='store_true')
    parser.add_argument('-F', '--filler', dest='filler',
                        help='set to read filler target',
                        default=False, required=False,
                        action='store_true')

    args = parser.parse_args()
    plan = args.plan
    observatory = args.observatory
    opentargets = args.opentargets
    filler = args.filler
    all_stages = args.all_stages

    cadencelist = roboscheduler.cadence.CadenceList(skybrightness_only=True)
    cadences_file = sdss_path.full('rsCadences', plan=plan,
                                   observatory=observatory)
    cadencelist.fromfits(filename=cadences_file, unpickle=True)

    c2cfile = os.path.join(os.getenv('ROBOSTRATEGY_DIR'), 'etc',
                           'cadence-list-{plan}.cfg'.format(plan=plan))
    if(os.path.exists(c2cfile)):
       c2c = configparser.ConfigParser(allow_no_value=True)
       c2c.optionxform = str
       c2c.read(c2cfile)
    else:
       c2c = None

    rsParams = params.RobostrategyParams(plan=plan)

    if('mwm_tess_ob_priority_fix' in rsParams.cfg['Cartons']):
        mwm_tess_ob_priority_fix = np.float32(rsParams.cfg['Cartons']['mwm_tess_ob_priority_fix'])
    else:
        mwm_tess_ob_priority_fix = None

    if('manual_validation_priority_fix' in rsParams.cfg['Cartons']):
        manual_validation_priority_fix = np.float32(rsParams.cfg['Cartons']['manual_validation_priority_fix'])
    else:
        manual_validation_priority_fix = None

    if('mwm_tess_planet_cadence_fix' in rsParams.cfg['Cartons']):
        mwm_tess_planet_cadence_fix = True
    else:
        mwm_tess_planet_cadence_fix = False

    if('dark_1x4_to_2x2_cadence_fix' in rsParams.cfg['Cartons']):
        dark_1x4_to_2x2_cadence_fix = True
    else:
        dark_1x4_to_2x2_cadence_fix = False

    if('bhm_colr_galaxies_lsdr8_cadence_fix' in rsParams.cfg['Cartons']):
        bhm_colr_galaxies_lsdr8_cadence_fix = True
    else:
        bhm_colr_galaxies_lsdr8_cadence_fix = False

    cartons_version = rsParams.cfg['Cartons']['version']
    cartons = robostrategy.targets.read_cartons(version=cartons_version)
    if(all_stages is False):
        stage = 'srd'
        if(opentargets):
            stage = 'open'
        if(filler):
            stage = 'filler'
        istage = np.where((cartons['stage'] == stage) &
                          (cartons['active'] == 'y'))[0]
    else:
        istage = np.where(cartons['active'] == 'y')[0]
    cartons = cartons[istage]

    adjust = dict()
    if('CartonsOpenPriorityAdjust' in rsParams.cfg):
        for carton in rsParams.cfg['CartonsOpenPriorityAdjust']:
            adjust[carton] = np.float32(rsParams.cfg.get('CartonsOpenPriorityAdjust',
                                                         carton))
    
    nt = 0
    for carton in cartons:
        name = carton['carton']
        version = carton['plan']
        nt = nt + robostrategy.targets.get_targets(name, version,
                                                   justcount=True, c2c=c2c)

    targets = np.zeros(nt, dtype=robostrategy.targets.target_dtype)

    nt = 0
    for carton in cartons:
        name = carton['carton']
        version = carton['plan']
        tmp_targets = robostrategy.targets.get_targets(name, version, c2c=c2c)
        if(tmp_targets is not None):
            if(name in adjust):
                tmp_targets['priority'] = (tmp_targets['priority'] +
                                           adjust[name])
            tmp_targets['stage'] = carton['stage']
            targets[nt:nt + len(tmp_targets)] = tmp_targets
            nt = nt + len(tmp_targets)

    if(nt != len(targets)):
        print("Lost some targets ... hope that is expected!")
        targets.resize(nt)

    # FUDGE filler galaxies
    if(bhm_colr_galaxies_lsdr8_cadence_fix):
        ifix = np.where((targets['carton'] == 'bhm_colr_galaxies_lsdr8')
                        & (targets['cadence'] == 'dark_1x4'))[0]
        targets['cadence'][ifix] = 'dark_single_4x1'

    # FUDGE dark_1x4 to dark_2x2
    if(dark_1x4_to_2x2_cadence_fix):
        i4 = np.where(targets['cadence'] == 'dark_1x4')[0]
        targets['cadence'][i4] = 'dark_flexible_2x2'

    # FUDGE TESS planet cadences
    if(mwm_tess_planet_cadence_fix):
        cadence_map = {'bright_1x2': 'bright_flexible_2x1',
                       'bright_1x3': 'bright_flexible_3x1',
                       'bright_1x4': 'bright_flexible_4x1',
                       'bright_1x5': 'bright_flexible_5x1',
                       'bright_1x6': 'bright_flexible_6x1'}
        for c in cadence_map:
            ii = np.where(targets['cadence'] == c)[0]
            targets['cadence'][ii] = cadence_map[c]

    # FUDGE TESS OB priority
    if(mwm_tess_ob_priority_fix is not None):
        ii = np.where(targets['carton'] == 'mwm_tess_ob')[0]
        targets['priority'][ii] = mwm_tess_ob_priority_fix

    # FUDGE manual validation priority
    if(manual_validation_priority_fix is not None):
        ii = np.where(targets['carton'] == 'manual_validation_apogee')[0]
        targets['priority'][ii] = manual_validation_priority_fix
        ii = np.where(targets['carton'] == 'manual_validation_boss')[0]
        targets['priority'][ii] = manual_validation_priority_fix

    # Fudge open_fiber into science
    iopen = np.where(targets['category'] == 'open_fiber')[0]
    if(len(iopen) > 0):
        print("Recategorizing {n} targets from open_fiber to science".format(n=len(iopen)))
        targets['category'][iopen] = 'science'

    targets_file = sdss_path.full('rsTargets', plan=plan,
                                  observatory=observatory)

    if(stage == 'open'):
        targets_file = targets_file.replace('rsTargets', 
                                            'rsTargetsOpen')

    if(stage == 'filler'):
        targets_file = targets_file.replace('rsTargets', 
                                            'rsTargetsFiller')

    hd = dict()
    hd['STRATVER'] = robostrategy.__version__
    fitsio.write(targets_file, targets, header=hd, clobber=True)
